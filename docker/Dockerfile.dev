FROM golang:1.26-bookworm

RUN apt-get update && apt-get install -y \
    clang \
    llvm \
    libbpf-dev \
    linux-headers-generic \
    linux-headers-amd64 \
    bpftool \
    iproute2 \
    iputils-ping \
    curl \
    git \
    vim \
    build-essential \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

RUN ln -sf /usr/include/x86_64-linux-gnu/asm /usr/include/asm || true

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

RUN go install github.com/a-h/templ/cmd/templ@latest
RUN go install github.com/cilium/ebpf/cmd/bpf2go@v0.16.0
RUN go install github.com/go-delve/delve/cmd/dlv@v1.22.1

COPY . .

RUN templ generate || true

RUN go build -o /bin/zt ./cmd/zt

ENV CGO_ENABLED=1
ENV ZEPTOR_ENV=development

EXPOSE 3000
EXPOSE 40000

CMD ["zt", "dev"]
